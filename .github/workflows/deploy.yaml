name: üöÄ Deploy Symfony App (app/ only)

on:
  push:
    branches:
      - main  # d√©ploiement automatique depuis la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, sqlite, zip, xml
          tools: composer
          coverage: none

      - name: üì¶ Install PHP dependencies
        run: |
          cd app
          composer install --no-interaction --optimize-autoloader

      - name: üöö Deploy `app/` folder to o2switch
        uses: appleboy/scp-action@v0.1.3
        with:
          host: jobmakombela.fr
          username: ruro5549
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "app/*"
          target: "/home/ruro5549/sites/jobmakombela.fr"

      - name: ‚öôÔ∏è Post-deploy commands (cache clear, migration, etc.)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: jobmakombela.fr
          username: ruro5549
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/ruro5549/sites/jobmakombela.fr
            php bin/console cache:clear --env=prod
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod
